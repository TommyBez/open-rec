name: Build Unsigned macOS DMGs

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-unsigned-dmg:
    name: Build ${{ matrix.target }} DMG
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        target: [aarch64-apple-darwin, x86_64-apple-darwin]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify frontend constraints
        run: pnpm run verify:frontend

      - name: Run frontend regression tests
        run: pnpm run test:frontend

      - name: Build unsigned DMG
        run: pnpm tauri build --bundles dmg --target ${{ matrix.target }}

      - name: Generate SHA256 checksum
        run: |
          cd src-tauri/target/${{ matrix.target }}/release/bundle/dmg
          for dmg in *.dmg; do
            shasum -a 256 "$dmg" > "$dmg.sha256"
          done

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: openrec-${{ matrix.target }}-dmg
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.sha256
          if-no-files-found: error

  upload-release-assets:
    name: Upload DMGs to GitHub Release
    if: github.event_name == 'release'
    needs: build-unsigned-dmg
    runs-on: ubuntu-latest

    steps:
      - name: Download all DMG artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-artifacts

      - name: Build unsigned changelog note
        env:
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          cat > dist-artifacts/UNSIGNED_BUILD_NOTES.md <<'EOF'
          # Unsigned OpenRec builds

          These binaries are intentionally unsigned (`signingIdentity: null`).
          On first launch macOS Gatekeeper will block the app; use:

          1. Finder â†’ Applications
          2. Right-click `Open Rec.app`
          3. Click **Open** and confirm

          Also grant Screen Recording/Microphone/Camera permissions when prompted.

          For full instructions see `docs/UNSIGNED_MAC_INSTALL.md`.
          EOF
          {
            echo "# OpenRec Release Changelog"
            echo
            if [ -n "$RELEASE_BODY" ]; then
              printf '%s\n' "$RELEASE_BODY"
            else
              echo "_No release notes were provided._"
            fi
          } > dist-artifacts/RELEASE_CHANGELOG.md

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          shopt -s globstar nullglob
          for file in dist-artifacts/**/*.dmg dist-artifacts/**/*.sha256 dist-artifacts/UNSIGNED_BUILD_NOTES.md dist-artifacts/RELEASE_CHANGELOG.md; do
            echo "Uploading $file"
            gh release upload "$RELEASE_TAG" "$file" --clobber
          done
